<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUIT Chatbot</title>
    <script src="socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="chat-container">
        <a href="https://huit.edu.vn/">
            <img src="./LogoHUIT.png" alt="Logo" class="logo">
        </a>
        <div id="messages"></div>
        <div id="footer">
            <div id="help-text" style="text-align: center; font-size: 18px; color: #000; margin-bottom: 10px;"><b>Tôi có
                    thể giúp gì cho bạn?</b></div>
            <div class="input-container">
                <input type="text" id="questionInput" placeholder="Nhập câu hỏi của bạn..." />
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <button class="icon-button" style="margin-left: 10px;" onclick="location.reload()"
                        title="Câu hỏi mới">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                            style="height:18px;width:18px;display:block;flex:none">
                            <path fill="currentColor"
                                d="M13 4.5a1 1 0 1 0-2 0V11H4.5a1 1 0 1 0 0 2H11v6.5a1 1 0 1 0 2 0V13h6.5a1 1 0 1 0 0-2H13V4.5Z">
                            </path>
                        </svg>
                    </button>
                    <button onclick="sendQuestion()" class="send-button" title="Gửi câu hỏi">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
                            style="height:18px;width:18px;display:block;flex:none">
                            <path fill="currentColor"
                                d="M4 13h14.09l-6.79 6.79a.996.996 0 1 0 1.41 1.41l8.5-8.5c.06-.06.09-.13.13-.2.03-.04.06-.08.08-.13a.91.91 0 0 0 .08-.37c0-.03-.01-.05-.01-.07-.01-.1-.02-.21-.06-.31a.955.955 0 0 0-.22-.33L12.72 2.8c-.2-.2-.45-.29-.71-.29-.26 0-.51.1-.71.29a.996.996 0 0 0 0 1.41L18.08 11H4c-.55 0-1 .45-1 1s.45 1 1 1Z">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="footer">
                <div>
                    <div class="d-flex align-items-center m-6">
                        <img src="./website.png" />
                        <span class="d-flex align-items-center">Website: <a href="https://ts.huit.edu.vn/" target="_blank">https://ts.huit.edu.vn/</a></span>
                    </div>
                    <div class="d-flex align-items-center m-4">
                        <img src="./phone.png" />
                        <span>Hotline: 096 205 1080</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <a href="https://zalo.me/4418938306145458374" target="_blank">
                        <img src="./zalo.png" class="logo-contact" />
                    </a>
                    <a href="https://www.facebook.com/DhCongThuongHCM" target="_blank">
                        <img src="./fb.png" class="logo-contact" />
                    </a>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        fetch("/config")
            .then(res => res.json())
            .then(config => {
                window.appConfig = config;
                const socket = io();
                let groupId = "group1";
                const messagesContainer = document.getElementById("messages");
            
                socket.emit("joinGroup", groupId);
            
                const messageQueue = [];
                let isProcessing = false;
                let accumulatedText = "";
                let previousHTML = "";
                let isSendFirst = false;
                let isSendFirstInNewQuestion = false;
            
                function removeCursor() {
                    let cursor = document.querySelector(".cursor");
                    if (cursor) cursor.remove();
                }
            
                function addCursor(parent) {
                    let cursor = document.querySelector(".cursor");
                    if (!cursor) {
                        cursor = document.createElement("span");
                        cursor.classList.add("cursor");
                        parent.appendChild(cursor);
                    }
                }
            
                socket.on("response", (data) => {
                    const serverMsg = document.querySelector(".server-message");
                    if (serverMsg) serverMsg.remove();
                    messageQueue.push(data.text);
                    if (data.isEnd) {
                        isSendFirstInNewQuestion = false;
                    }
            
                    if (!isProcessing) processQueue();
                });

                function delay(ms) {
                    const start = performance.now();
                    return new Promise(resolve => {
                        function check() {
                            if (performance.now() - start >= ms) return resolve();
                            requestAnimationFrame(check); // dùng RAF giúp đều đặn hơn
                        }
                        check();
                    });
                }
            
                async function processQueue() {
                    if (isProcessing) return;
                    isProcessing = true;
            
                    let lastMsg = messagesContainer.lastElementChild;
                    if (!lastMsg || !lastMsg.classList.contains("response")) {
                        lastMsg = document.createElement("div");
                        lastMsg.classList.add("message", "response");
                        const textSpan = document.createElement("span");
                        textSpan.classList.add("text-content");
                        lastMsg.appendChild(textSpan);
                        messagesContainer.appendChild(lastMsg);
                    }
            
                    const textContainer = lastMsg.querySelector(".text-content");
            
                    while (messageQueue.length > 0) {
                        const nextChar = messageQueue.shift();
                        accumulatedText += nextChar;
            
                        const span = document.createElement("span");
                        span.textContent = nextChar;
                        textContainer.appendChild(span);
                        removeCursor();
                        addCursor(span);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        delay(15)
            
                        if (/\n$|[.?!]$/.test(accumulatedText)) {
                            const html = marked.parse(accumulatedText);
                            if (html !== previousHTML) {
                                textContainer.innerHTML = html;
                                previousHTML = html;
                            }
                        }
                    }
            
                    isProcessing = false;
            
                    if (messageQueue.length === 0 && !isSendFirstInNewQuestion) {
                        const input = document.getElementById("questionInput");
                        const sendButton = document.querySelector(".send-button");
                        input.disabled = false;
                        sendButton.disabled = false;
                        removeCursor();
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;
                        if(!isMobile) {
                            input.focus();
                        }
                    }
                }
            
                function sendQuestion() {
                    const input = document.getElementById("questionInput");
                    const sendButton = document.querySelector(".send-button");
            
                    if (input.value.trim() == "") return;
            
                    const wordCount = input.value.trim().split(/\s+/).length;
                    if (wordCount > window.appConfig.MAX_LEN_CLIENT_SEND) {
                        Swal.fire({
                            title: 'Cảnh báo!',
                            text: 'Tin nhắn vượt quá giới hạn từ. Vui lòng rút gọn!',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        return;
                    }
            
                    if (!isSendFirst) {
                        isSendFirst = true;
                        const helpText = document.getElementById("help-text");
                        helpText.textContent = "";
                    }
            
                    input.disabled = true;
                    sendButton.disabled = true;
            
                    if (input.value.trim() !== "") {
                        const userMsg = document.createElement("div");
                        userMsg.classList.add("message", "user-message");
                        userMsg.textContent = input.value;
                        messagesContainer.appendChild(userMsg);
            
                        if (!isSendFirstInNewQuestion) {
                            isSendFirstInNewQuestion = true;
                            const serverMsg = document.createElement("div");
                            serverMsg.classList.add("message", "server-message");
            
                            const textSpan = document.createElement("span");
                            textSpan.textContent = "Vui lòng chờ trong giây lát ";
            
                            const loadingGif = document.createElement("img");
                            loadingGif.src = "./loading.gif";
                            loadingGif.style.width = "20px";
                            loadingGif.style.height = "20px";
                            loadingGif.style.marginLeft = "5px";
            
                            serverMsg.appendChild(textSpan);
                            serverMsg.appendChild(loadingGif);
                            messagesContainer.appendChild(serverMsg);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        }
            
                        // Reset cho response mới
                        accumulatedText = "";
                        previousHTML = "";
            
                        socket.emit("sendQuestion", { groupId, question: input.value });
                        input.value = "";
                    }
                }
            
                document.getElementById("questionInput").addEventListener("keypress", function (event) {
                    if (event.key === "Enter") {
                        sendQuestion();
                    }
                });
            })
            .catch(err => {
                document.body.innerHTML += "<p style='color:red;'>Không load được cấu hình.</p>";
                console.error("Lỗi khi tải config:", err);
            });
    </script>
    
</body>

</html>